
## Import

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
library(gridExtra)
```

## Read in the data

```{r}
df <- read.csv("aiddata_reduced.csv")
```

## Q1 
Question 1: a) How does the amount donated vs. amount received change over time for each country?; b) Are there countries that mostly send or mostly receive and countries that have a similar amount of donations they receive and send?; c) Are there countries that change their role over time? That is, they used to mostly send donations and turn into mostly receiving donations and vice-versa?; d) Are there countries in which you can find a sudden increase (“peak”) or a sudden decrease (“valley”)?

```{r}
# convert to long format
df_long <-
  df %>%
  pivot_longer(
    cols = c("donor", "recipient"),
    names_to = "role",
    values_to = "country"
  )
```

### Get the role of each country

```{r}
df_role_each_country <-
  df_long %>%
  group_by(country) %>%
  summarise(
    n_donate = sum(role == "donor"),
    n_receive = sum(role == "recipient")
  ) %>%
  mutate(country_role = case_when(
    (n_donate > 0 & n_receive == 0) ~ "donor_only",
    (n_donate == 0 & n_receive > 0) ~ "recipient_only",
    (n_donate > 0 & n_receive > 0) ~ "donor_and_recipient"
  ))

# attach to the long data
df_long <-
  df_long %>%
  left_join(df_role_each_country %>%
    select(country, country_role), by = "country")
```

## Get the slope of each linear regression model 
- corresponds to `geom_smooth(method='lm', formula= y~x)` below

```{r}
df_lm_each_country <-
  df_long %>%
  group_by(country) %>%
  do({
    mod <- lm(log10(commitment_amount_usd_constant) ~ year, data = .)
    data.frame(
      Intercept = coef(mod)[1],
      Slope = coef(mod)[2]
    )
  })

country_order_by_slope <-
  df_lm_each_country %>%
  arrange(desc(Slope)) %>%
  pull(country)

# attach to the long data
df_long <-
  df_long %>%
  left_join(df_lm_each_country %>%
    select(country, lm_slope = Slope), by = "country")

# factorize the country
df_long <-
  df_long %>%
  mutate(country = factor(country, levels = country_order_by_slope))
```

```{r}
# a) How does the amount donated vs. amount received change over time for each country?
# df_long %>%
#   # filter(country=="Korea")%>%
#   ggplot(aes(x=year,y=commitment_amount_usd_constant,color=role))+
#   geom_line()+
#   geom_point()+
#   geom_smooth(method='lm', formula= y~x,color = "black",se=FALSE)+
#   facet_wrap(country_role~country)+
#   scale_y_continuous(
#     trans = log10_trans(),
#     breaks = trans_breaks("log10", function(x) 10^x),
#     labels = trans_format("log10", math_format(10^.x))
#     )

# a-1) donor-only country
COLOR_DONOR <- "#619CFF"
g_donor = 
  df_long %>%
  # sort the country based on the slope
  # mutate(country=factor(country,levels = ))%>%
  filter(country_role == "donor_only") %>%
  ggplot(aes(x = year, y = commitment_amount_usd_constant)) +
  geom_line(color = COLOR_DONOR) +
  geom_point(color = COLOR_DONOR) +
  geom_smooth(method = "lm", formula = y ~ x, color = "black", se = FALSE) +
  facet_wrap(. ~ country) +
  scale_y_continuous(
    trans = log10_trans(),
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  labs(
    x = "year", y = "Amount (USD)",
    title = "Countries that are donors (without reception records)"
  )
# a-2) reception-only country
COLOR_RECIPIENT <- "#F8766D"
g_recipeint = 
  df_long %>%
  filter(country_role == "recipient_only") %>%
  ggplot(aes(x = year, y = commitment_amount_usd_constant)) +
  geom_line(color = COLOR_RECIPIENT) +
  geom_point(color = COLOR_RECIPIENT) +
  geom_smooth(method = "lm", formula = y ~ x, color = "black", se = FALSE) +
  facet_wrap(. ~ country) +
  scale_y_continuous(
    trans = log10_trans(),
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  labs(
    x = "year", y = "Amount (USD)",
    title = "Countries that are recipients (without donation records)"
  )
```

```{r}
# grid.arrange(g_donor, g_recipeint, ncol = 1)
g = arrangeGrob(g_donor, g_recipeint, ncol = 1,nrow = 2)
ggsave(filename = "1.pdf",plot = g,
       width = 6.65,height = 7.25,scale = 2)

```
